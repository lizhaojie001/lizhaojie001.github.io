<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="严青的博客">
    <meta name="keyword"  content="中科创达">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Json中含有null处理办法(转) - 严青的博客 | YQ&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Half measures are as bad as nothing at all </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/author.jpg" />
        </div>
        <div class="name">
            <i>严青</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#关于Json中null的问题以及宏的返回值"><span class="toc-text">关于Json中null的问题以及宏的返回值</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方法"><span class="toc-text">解决方法</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> Half measures are as bad as nothing at all </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Json中含有null处理办法(转)
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2016-11-16 11:25:15</span></span>
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="关于Json中null的问题以及宏的返回值"><a href="#关于Json中null的问题以及宏的返回值" class="headerlink" title="关于Json中null的问题以及宏的返回值"></a>关于Json中null的问题以及宏的返回值</h1><blockquote>
<p>在iOS开发过程中经常需要与服务器进行数据通讯，Json就是一种常用的高效简洁的数据格式。<br>问题现象</p>
</blockquote>
<p>但是几个项目下来一直遇到一个坑爹的问题，程序在获取某些数据之后莫名崩溃。其实很早就发现了原因：由于服务器的数据库中有些字段为空，然后以Json形式返回给客户端时就会出现这样的数据：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"somevalue":</span><span class="literal">null</span></span><br></pre></td></tr></table></figure></p>
<p>通过JsonKit 这个第三方库解析出来的数据就成了<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">somevalue</span> = <span class="string">"&lt;null&gt;"</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>这个数据类型不是nil 也不是 String。 解析成对象之后，如果直接向这个对象发送消息（eg：length，count 等等）就会直接崩溃。提示错误为：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-[NSNull length]: unrecognized selector sent <span class="keyword">to</span><span class="built_in"> instance </span>0x388a4a70</span><br></pre></td></tr></table></figure></p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>其实一直没有找到完美的解决办法，坑了我很久。</p>
<ul>
<li>1、最开始的解决方法就是为了应付当前遇到的崩溃，看看哪个字段可能为空，那么就对该字段使用前进行判断，通过崩溃时的错误提示可以看出，这样的字段解析成的对象是 NSNull 类型的，所以可以直接判断是不是此类型：<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (![<span class="string">isKindOfClass:</span>[NSNull <span class="class"><span class="keyword">class</span>]])&#123;</span>xxxxxxx;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>因为字段实在太多，就找一个补一个。</p>
<ul>
<li>2、后来想彻底解决这问题，就打算从数据源下手，其实应该可以用正则表达式匹配这个null ，然后进行替换，奈何正则是我的硬伤啊。于是就相出了一个山寨方法：字符串匹配。在获取到服务器返回的Json时，返回结果时string对象，于是就先替换 null 为 为空字符””，然后再解析。<br>json = [jsonStr  stringByReplacingOccurrencesOfString:@”:null” withString:@”:\”\””];</li>
</ul>
<p>这个方法本来很奏效，但是我这里的服务器返回极不简洁，各种垃圾数据（不吐槽这了）。。。反正这样会导致json无法解析了。</p>
<ul>
<li>3、最后没有办法，只能在解析的时候下手，把是NSNull 类型的值替换成nil。 一般就写个tool方法，然后解析时调用。但是嫌太麻烦，就想弄写个宏，通过搜索惊奇的发现宏也是可以有返回值的，结果如下：</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define VerifyValue(value)\</span></span><br><span class="line">(&#123;<span class="keyword">id</span> tmp;\</span><br><span class="line"><span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSNull</span> <span class="keyword">class</span>]])\</span><br><span class="line">tmp = <span class="literal">nil</span>;\</span><br><span class="line"><span class="keyword">else</span>\</span><br><span class="line">tmp = value;\</span><br><span class="line">tmp;\</span><br><span class="line">&#125;)\</span><br></pre></td></tr></table></figure>
<p>宏里的最后一句语句便是返回值。然后在解析数据时调用宏：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contact.contactPhone = VerifyValue(contactDic[@<span class="string">"send_ContactPhone"</span>])<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>4、如果你使用AFNetwork 这个库做网络请求的话，可以用以下代码，自动帮你去掉这个讨厌的空值<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.removesKeysWithNullValues = <span class="literal">YES</span>;</span><br></pre></td></tr></table></figure></p>
<p>5、终极方案<br>终于找到了一劳永逸的方案，牛逼的老外写了一个Category，叫做NullSafe ，在运行时操作，把这个讨厌的空值置为nil，而nil是安全的，可以向nil对象发送任何message而不会奔溃。这个category使用起来非常方便，只要加入到了工程中就可以了，你其他的什么都不用做，对，就是这么简单。详细的请去Github上查看；<br><a href="https://github.com/nicklockwood/NullSafe" target="_blank" rel="noopener">https://github.com/nicklockwood/NullSafe</a></p>
<p>转自<a href="http://www.pan-apps.com/668.html#comment-94781" target="_blank" rel="noopener">LP 的移动应用开发</a></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">donate</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢鼓励 </p>
    </div>
</div>
        
        <div id="comment-container">
        </div>
    </div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/3293104657">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/lizhaojie001">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/gitment.js"></script>
<script>
    var gitment = new Gitment({
        id: 'Json中含有null处理办法(转)',
        owner: '严青',
        repo: 'hexo-aircloud-blog',
        oauth: {
            client_id: '1ec42b02a0e9e84bfe10',
            client_secret: 'f6fc589ccc3f6ce440143bcf753609977ce63e52',
        },
    })
    gitment.render('comment-container')
</script>

</html>
